import pandas as pd
from openpyxl import load_workbook
from openpyxl.chart import BarChart, Reference

# Path to your Excel file
file_path = r"C:\Users\sgandham\Downloads\performance_comparison.xlsx"

# Read the sheets
df1 = pd.read_excel(file_path, sheet_name='Dataset1')
df2 = pd.read_excel(file_path, sheet_name='Dataset2')

# Validate columns
if not (df1['ReadRatio(%)'].equals(df2['ReadRatio(%)']) and df1['IOSize(KB)'].equals(df2['IOSize(KB)'])):
    raise ValueError("ReadRatio(%) or IOSize(KB) columns do not match between Dataset1 and Dateset2.")

# Calculate IOPS variance
df1['Variance'] = df2['IOPS'] - df1['IOPS']

# Prepare variance DataFrame
variance_df = pd.DataFrame({
    'ReadRatio(%)': df1['ReadRatio(%)'],
    'IOSize(KB)': df1['IOSize(KB)'],
    'IOPS_Dataset1': df1['IOPS'],
    'IOPS_Dataset2': df2['IOPS'],
    'Variance': df1['Variance']
})

# Write to Excel (add new sheet)
with pd.ExcelWriter(file_path, engine='openpyxl', mode='a', if_sheet_exists='replace') as writer:
    variance_df.to_excel(writer, sheet_name='IOPSvar', index=False)

print("Sheet 'IOPSvar' created successfully.")

# Reload workbook to add chart
wb = load_workbook(file_path)
ws = wb['IOPSvar']

# Create combined X-axis labels like "70% - 64KB"
combined_labels = [
    f"{row[0]}% - {row[1]}KB" for row in zip(variance_df['ReadRatio(%)'], variance_df['IOSize(KB)'])
]
ws.insert_cols(1)
ws.cell(row=1, column=1, value="Label")
for i, label in enumerate(combined_labels, start=2):
    ws.cell(row=i, column=1, value=label)

# Create the bar chart
chart = BarChart()
chart.type = "col"
chart.title = "IOPS Variance (Dataset2 - Dataset1)"
chart.y_axis.title = "Variance"
chart.x_axis.title = "ReadRatio(%) / IOSize(KB)"

# Chart data
data = Reference(ws, min_col=6, min_row=1, max_row=ws.max_row)  # Variance column (after inserting col)
cats = Reference(ws, min_col=1, min_row=2, max_row=ws.max_row)  # Combined label column

chart.add_data(data, titles_from_data=True)
chart.set_categories(cats)
chart.width = 20
chart.height = 10

# Add chart to sheet
ws.add_chart(chart, "H2")

# Save workbook
wb.save(file_path)
print("Bar chart added successfully to 'IOPSvar' sheet.")
